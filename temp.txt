AWSTemplateFormatVersion: '2010-09-09'
Description: Lambda AutoScaler for Provisioned Concurrency

Parameters:
  FunctionName:
    Type: String
  AliasName:
    Type: String
    Default: live

Resources:
  AutoScalerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${FunctionName}-AutoScaler"
      Runtime: python3.12
      Handler: autoscaler.lambda_handler
      Code:
        S3Bucket: YOUR_BUCKET
        S3Key: autoscaler.zip
      Role: arn:aws:iam::YOUR_ACCOUNT_ID:role/YOUR_EXECUTION_ROLE
      Timeout: 60
      Environment:
        Variables:
          FUNCTION_NAME: !Ref FunctionName
          ALIAS_NAME: !Ref AliasName

  ScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: rate(5 minutes)
      Targets:
        - Arn: !GetAtt AutoScalerFunction.Arn
          Id: TargetFunctionV1

  PermissionForEventsToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AutoScalerFunction
      Action: 'lambda:InvokeFunction'
      Principal: 'events.amazonaws.com'
      SourceArn: !GetAtt ScheduleRule.Arn
